@page "/system_user"
@using Common.Model
@using Common.Model.UsUser
@using Common.Model.UsGroup
@using Common.Model.Common
@using Common.Library.Constant
@using WebBlazor.Services
@using WebBlazor.Components
@using Microsoft.AspNetCore.Components.Forms
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.AspNetCore.Components.Authorization
@inject UserApiClient UserService
@inject NotificationService NotificationService
@inject IJSRuntime JS

<style>
    /* Thêm border cho MudDataGrid */
    .mud-table-bordered {
        border: 1px solid rgba(0, 0, 0, 0.12);
    }
    
    .mud-table-bordered .mud-table-head .mud-table-cell {
        border-bottom: 2px solid rgba(0, 0, 0, 0.12);
        border-right: 1px solid rgba(0, 0, 0, 0.12);
        font-weight: 600;
    }
    
    .mud-table-bordered .mud-table-cell {
        border-right: 1px solid rgba(0, 0, 0, 0.12);
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
    }
    
    .mud-table-bordered .mud-table-row:hover {
        background-color: rgba(0, 0, 0, 0.04);
    }

    /* Hiệu ứng highlight cho row vừa thêm/sửa/xóa */
    @@keyframes highlightRow {
        0% {
            background-color: #d4edda;
            transform: scale(1.02);
        }
        50% {
            background-color: #c3e6cb;
        }
        100% {
            background-color: transparent;
            transform: scale(1);
        }
    }

    @@keyframes deleteHighlight {
        0% {
            background-color: #f8d7da;
            transform: scale(0.98);
        }
        50% {
            background-color: #f5c6cb;
        }
        100% {
            background-color: transparent;
            opacity: 0.5;
        }
    }

    .row-highlight-success {
        animation: highlightRow 1.5s ease-in-out;
    }

    .row-highlight-delete {
        animation: deleteHighlight 0.8s ease-in-out;
    }

    /* Custom Column Visibility Dropdown */
    .column-visibility-dropdown {
        position: relative;
        display: inline-block;
    }

    .column-visibility-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.12);
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
    }

    .column-visibility-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .column-visibility-item:hover {
        background-color: rgba(0, 0, 0, 0.04);
    }

    .column-visibility-item input[type="checkbox"] {
        margin-right: 8px;
    }

    .column-visibility-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Danh sách người dùng</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                          Color="Color.Primary" 
                          OnClick="@(async () => await RefreshData())" 
                          Title="Làm mới" />
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudDataGrid T="UsUserViewModel" 
                    ServerData="@(new Func<GridState<UsUserViewModel>, Task<GridData<UsUserViewModel>>>(LoadServerData))"
                    MultiSelection="false"
                    Filterable="false"
                    Hideable="false"
                    ColumnResizeMode="ResizeMode.Column"
                    RowClass="GetRowClass"
                    Dense="true"
                    Hover="true"
                    Loading="@isLoading"
                    Class="mud-table-bordered"
                    Height="calc(100vh - 300px)"
                    @ref="dataGrid">
            <ToolBarContent>
                <MudButton StartIcon="@Icons.Material.Filled.Add" 
                          Color="Color.Primary" 
                          Variant="Variant.Filled"
                          OnClick="@OpenAddModal">
                    Thêm mới
                </MudButton>
                <MudSpacer />
                
                <!-- Custom Column Visibility Button -->
                <div class="column-visibility-dropdown">
                    <MudButton StartIcon="@Icons.Material.Filled.ViewColumn"
                              Color="Color.Default"
                              Variant="Variant.Outlined"
                              OnClick="@(() => showColumnMenu = !showColumnMenu)"
                              Style="margin-right: 8px;">
                        Column visibility
                    </MudButton>
                    
                    @if (showColumnMenu)
                    {
                        <div class="column-visibility-menu" @onclick:stopPropagation="true">
                            @foreach (var col in columnVisibility)
                            {
                                <label class="column-visibility-item @(col.Value.IsRequired ? "disabled" : "")" style="cursor: pointer; user-select: none;">
                                    <input type="checkbox" 
                                           checked="@col.Value.IsVisible" 
                                           disabled="@col.Value.IsRequired" 
                                           @onchange="@((e) => { if (!col.Value.IsRequired) { col.Value.IsVisible = (bool)(e.Value ?? false); StateHasChanged(); } })" />
                                    <span>@col.Value.Title</span>
                                </label>
                            }
                        </div>
                    }
                </div>

                <MudTextField @bind-Value="_searchString" 
                             Placeholder="Tìm kiếm..." 
                             Adornment="Adornment.Start" 
                             Immediate="false"
                             AdornmentIcon="@Icons.Material.Filled.Search" 
                             IconSize="Size.Medium" 
                             Class="mt-0"
                             DebounceInterval="500"
                             OnDebounceIntervalElapsed="@OnSearch">
                </MudTextField>
            </ToolBarContent>
            <Columns>
                @if (columnVisibility["Id"].IsVisible)
                {
                    <PropertyColumn Property="x => x.Id" Title="ID" />
                }
                @if (columnVisibility["GroupName"].IsVisible)
                {
                    <PropertyColumn Property="x => x.GroupName" Title="Nhóm" />
                }
                @if (columnVisibility["Name"].IsVisible)
                {
                    <PropertyColumn Property="x => x.Name" Title="Họ Tên" />
                }
                @if (columnVisibility["UserName"].IsVisible)
                {
                    <PropertyColumn Property="x => x.UserName" Title="Tên đăng nhập" />
                }
                @if (columnVisibility["Email"].IsVisible)
                {
                    <PropertyColumn Property="x => x.Email" Title="Email" />
                }
                @if (columnVisibility["Phone"].IsVisible)
                {
                    <PropertyColumn Property="x => x.Phone" Title="Điện thoại" />
                }
                @if (columnVisibility["CMND"].IsVisible)
                {
                    <PropertyColumn Property="x => x.CMND" Title="CMND" />
                }
                @if (columnVisibility["Address"].IsVisible)
                {
                    <PropertyColumn Property="x => x.Address" Title="Địa chỉ" />
                }
                @if (columnVisibility["Note"].IsVisible)
                {
                    <PropertyColumn Property="x => x.Note" Title="Ghi chú" />
                }
                @if (columnVisibility["CreatedAt"].IsVisible)
                {
                    <PropertyColumn Property="x => x.CreatedAt" Title="Ngày tạo">
                        <CellTemplate>
                            @context.Item.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                        </CellTemplate>
                    </PropertyColumn>
                }
                @if (columnVisibility["CreatedBy"].IsVisible)
                {
                    <PropertyColumn Property="x => x.CreatedBy" Title="Người tạo" />
                }
                @if (columnVisibility["UpdatedAt"].IsVisible)
                {
                    <PropertyColumn Property="x => x.UpdatedAt" Title="Ngày cập nhật">
                        <CellTemplate>
                            @context.Item.UpdatedAt.ToString("dd/MM/yyyy HH:mm")
                        </CellTemplate>
                    </PropertyColumn>
                }
                @if (columnVisibility["UpdatedBy"].IsVisible)
                {
                    <PropertyColumn Property="x => x.UpdatedBy" Title="Người cập nhật" />
                }
                
                <TemplateColumn Title="Hành động" Sortable="false" Filterable="false">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Color="Color.Info" 
                                      Size="Size.Small"
                                      OnClick="@(async () => await OpenEditModal(context.Item.Id))"
                                      Title="Chỉnh sửa" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                      Color="Color.Error" 
                                      Size="Size.Small"
                                      OnClick="@(() => ConfirmAndDelete(context.Item))"
                                      Title="Xóa" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="UsUserViewModel" 
                                 PageSizeOptions="@(new int[] { 10, 25, 50, 100 })" />
            </PagerContent>
        </MudDataGrid>
    </MudCardContent>
</MudCard>

<!-- User Modal Component -->
<UserModal UserModel="usUserFormModel"
           IsEditMode="isEditMode"
           IsProcessing="isProcessing"
           Groups="allGroups"
           @bind-Password="password"
           @bind-ConfirmPassword="confirmPassword"
           OnSubmit="HandleSaveUser"
           OnClose="CloseModals" />

<!-- Delete Confirmation Dialog -->
<DeleteConfirmDialog @ref="deleteConfirmDialog"
                     Title="Xác nhận xóa"
                     OnConfirm="HandleDeleteUser" />

@code {
    // DataGrid reference
    private MudDataGrid<UsUserViewModel>? dataGrid;
    
    // Delete dialog reference
    private DeleteConfirmDialog? deleteConfirmDialog;
    
    private List<UsGroupViewModel> allGroups = new();
    private bool isLoading = false;
    private string _searchString = string.Empty;
    
    // Store current user to delete
    private UsUserViewModel? userToDelete;

    // Modal states
    private UsUserFormModel usUserFormModel = new();
    private bool isEditMode = false;
    private bool isProcessing = false;
    private string password = string.Empty;
    private string confirmPassword = string.Empty;

    // Column visibility states
    private bool showColumnMenu = false;
    private string? highlightedRowId = null;
    private string? highlightClass = null;

    // Column visibility configuration
    private class ColumnVisibilityConfig
    {
        public string Title { get; set; } = string.Empty;
        public bool IsVisible { get; set; } = true;
        public bool IsRequired { get; set; } = false;
    }

    private Dictionary<string, ColumnVisibilityConfig> columnVisibility = new()
    {
        { "Id", new ColumnVisibilityConfig { Title = "ID", IsVisible = true } },
        { "GroupName", new ColumnVisibilityConfig { Title = "Nhóm", IsVisible = true } },
        { "Name", new ColumnVisibilityConfig { Title = "Họ Tên", IsVisible = true, IsRequired = true } },
        { "UserName", new ColumnVisibilityConfig { Title = "Tên đăng nhập", IsVisible = true, IsRequired = true } },
        { "Email", new ColumnVisibilityConfig { Title = "Email", IsVisible = false } },
        { "Phone", new ColumnVisibilityConfig { Title = "Điện thoại", IsVisible = true } },
        { "CMND", new ColumnVisibilityConfig { Title = "CMND", IsVisible = false } },
        { "Address", new ColumnVisibilityConfig { Title = "Địa chỉ", IsVisible = false } },
        { "Note", new ColumnVisibilityConfig { Title = "Ghi chú", IsVisible = false } },
        { "CreatedAt", new ColumnVisibilityConfig { Title = "Ngày tạo", IsVisible = false } },
        { "CreatedBy", new ColumnVisibilityConfig { Title = "Người tạo", IsVisible = false } },
        { "UpdatedAt", new ColumnVisibilityConfig { Title = "Ngày cập nhật", IsVisible = false } },
        { "UpdatedBy", new ColumnVisibilityConfig { Title = "Người cập nhật", IsVisible = false } }
    };

    // Method để MudDataGrid có thể gọi
    private string GetRowClass(UsUserViewModel user, int index)
    {
        if (user.Id == highlightedRowId)
        {
            return highlightClass ?? string.Empty;
        }
        return string.Empty;
    }

    private void ToggleColumn(string columnKey)
    {
        if (columnVisibility[columnKey].IsRequired) return;
        
        columnVisibility[columnKey].IsVisible = !columnVisibility[columnKey].IsVisible;
        StateHasChanged();
    }

    private async Task HighlightRow(string userId, string cssClass, int durationMs = 1500)
    {
        highlightedRowId = userId;
        highlightClass = cssClass;
        StateHasChanged();

        await Task.Delay(durationMs);
        
        highlightedRowId = null;
        highlightClass = null;
        StateHasChanged();
    }

    // xử lý nạp động các js sau khi DOM render xong
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JS.InvokeVoidAsync("adminAssetManager.initAdminLayout");
                
                // Initialize column visibility handler
                var dotNetRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("columnVisibilityHandler.init", dotNetRef);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Dashboard Script Load Error: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public void CloseColumnMenu()
    {
        showColumnMenu = false;
        StateHasChanged();
    }

    // Server-side data loading
    private async Task<GridData<UsUserViewModel>> LoadServerData(GridState<UsUserViewModel> state)
    {
        isLoading = true;
        try
        {
            var request = new PaginatedRequest
            {
                PageNumber = state.Page + 1, // MudBlazor uses 0-based index
                PageSize = state.PageSize,
                SearchTerm = _searchString,
                SortColumn = state.SortDefinitions.FirstOrDefault()?.SortBy ?? string.Empty,
                SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending == true ? "desc" : "asc"
            };

            var response = await UserService.GetPaginatedUsersAsync(request);

            return new GridData<UsUserViewModel>
            {
                Items = response.Items,
                TotalItems = response.TotalRecords
            };
        }
        catch (Exception ex)
        {
            await ShowNotification("error", $"Lỗi tải dữ liệu: {ex.Message}");
            return new GridData<UsUserViewModel> { Items = new List<UsUserViewModel>(), TotalItems = 0 };
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearch()
    {
        if (dataGrid != null)
        {
            await dataGrid.ReloadServerData();
        }
    }

    private async Task RefreshData()
    {
        if (dataGrid != null)
        {
            await dataGrid.ReloadServerData();
        }
    }

    private async Task LoadGroups()
    {
        try
        {
            allGroups = (await UserService.GetAllGroupsAsync()).ToList();
        }
        catch (Exception ex)
        {
            await ShowNotification("error", $"Lỗi tải nhóm: {ex.Message}");
        }
    }

    #region Modal Operations

    private async Task OpenAddModal()
    {
        isEditMode = false;
        await LoadGroups();
        usUserFormModel = new UsUserFormModel { RowStatus = 1, ChangePassword = false };
        password = string.Empty;
        confirmPassword = string.Empty;
        StateHasChanged();
        await JS.InvokeVoidAsync("eval", "$('#userModal').modal('show')");
    }

    private async Task OpenEditModal(string userId)
    {
        try
        {
            var user = await UserService.GetUserByIdAsync(userId);
            if (user != null)
            {
                isEditMode = true;
                await LoadGroups();
                usUserFormModel = new UsUserFormModel
                {
                    Id = user.Id,
                    Name = user.Name,
                    UserName = user.UserName,
                    GroupId = user.GroupId,
                    Email = user.Email,
                    Phone = user.Phone,
                    Gender = user.Gender,
                    CMND = user.CMND,
                    Address = user.Address,
                    Image = user.Image,
                    Note = user.Note,
                    RowStatus = user.RowStatus,
                    ChangePassword = false
                };
                password = string.Empty;
                confirmPassword = string.Empty;
                StateHasChanged();
                await JS.InvokeVoidAsync("eval", "$('#userModal').modal('show')");
            }
        }
        catch (Exception ex)
        {
            await ShowNotification("error", $"Lỗi: {ex.Message}");
        }
    }

    private void ConfirmAndDelete(UsUserViewModel user)
    {
        userToDelete = user;
        deleteConfirmDialog?.Show($"Bạn có chắc chắn muốn xóa người dùng '{user.Name}' không?");
    }

    private async Task CloseModals()
    {
        await JS.InvokeVoidAsync("eval", "$('#userModal').modal('hide')");
        usUserFormModel = new UsUserFormModel();
        password = string.Empty;
        confirmPassword = string.Empty;
        isProcessing = false;
        StateHasChanged();
    }

    #endregion

    #region CRUD Operations

    private async Task HandleSaveUser()
    {
        if (isProcessing) return;

        isProcessing = true;
        StateHasChanged();

        try
        {
            // Validation cơ bản
            if (string.IsNullOrWhiteSpace(usUserFormModel.Name))
            {
                await ShowNotification("error", "Vui lòng nhập tên người dùng!");
                return;
            }

            if (string.IsNullOrWhiteSpace(usUserFormModel.UserName))
            {
                await ShowNotification("error", "Vui lòng nhập tên đăng nhập!");
                return;
            }

            if (string.IsNullOrWhiteSpace(usUserFormModel.GroupId))
            {
                await ShowNotification("error", "Vui lòng chọn nhóm!");
                return;
            }

            if (!isEditMode)
            {
                if (string.IsNullOrWhiteSpace(password))
                {
                    await ShowNotification("error", MessageConstant.PASSWORD_NOT_NULL);
                    return;
                }

                if (password != confirmPassword)
                {
                    await ShowNotification("error", MessageConstant.PASSWORD_NOT_MATCH);
                    return;
                }

                var createRequest = new UsUserCreateModel
                {
                    Name = usUserFormModel.Name,
                    UserName = usUserFormModel.UserName,
                    Password = password,
                    GroupId = usUserFormModel.GroupId,
                    Email = usUserFormModel.Email,
                    Phone = usUserFormModel.Phone,
                    Gender = usUserFormModel.Gender,
                    CMND = usUserFormModel.CMND,
                    Address = usUserFormModel.Address,
                    Note = usUserFormModel.Note,
                    RowStatus = usUserFormModel.RowStatus
                };

                var newUser = await UserService.CreateUserAsync(createRequest);

                if (newUser != null)
                {
                    await CloseModals();
                    await ShowNotification("success", $"Thêm người dùng '{newUser.Name}' thành công!");
                    await RefreshData();
                    
                    // Highlight row vừa thêm
                    await HighlightRow(newUser.Id, "row-highlight-success");
                }
            }
            else
            {
                var updateRequest = new UsUserUpdateModel
                {
                    Id = usUserFormModel.Id,
                    Name = usUserFormModel.Name,
                    UserName = usUserFormModel.UserName,
                    GroupId = usUserFormModel.GroupId,
                    Email = usUserFormModel.Email,
                    Phone = usUserFormModel.Phone,
                    Gender = usUserFormModel.Gender,
                    CMND = usUserFormModel.CMND,
                    Address = usUserFormModel.Address,
                    Note = usUserFormModel.Note,
                    RowStatus = usUserFormModel.RowStatus,
                    IsChangePassword = usUserFormModel.ChangePassword,
                    Password = usUserFormModel.ChangePassword ? password : null
                };

                if (updateRequest.IsChangePassword == true)
                {
                    if (string.IsNullOrWhiteSpace(password))
                    {
                        await ShowNotification("error", MessageConstant.PASSWORD_NOT_NULL);
                        return;
                    }

                    if (password != confirmPassword)
                    {
                        await ShowNotification("error", MessageConstant.PASSWORD_NOT_MATCH);
                        return;
                    }
                }

                var updatedUser = await UserService.UpdateUserAsync(updateRequest);

                if (updatedUser != null)
                {
                    await CloseModals();
                    await ShowNotification("success", $"Cập nhật người dùng '{updatedUser.Name}' thành công!");
                    await RefreshData();
                    
                    // Highlight row vừa cập nhật
                    await HighlightRow(updatedUser.Id, "row-highlight-success");
                }
            }
        }
        catch (Exception ex)
        {
            await ShowNotification("error", $"Lỗi: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task HandleDeleteUser()
    {
        if (userToDelete == null || isProcessing) return;

        isProcessing = true;
        StateHasChanged();

        try
        {
            // Highlight row trước khi xóa
            await HighlightRow(userToDelete.Id, "row-highlight-delete", 800);

            var result = await UserService.DeleteUserAsync(userToDelete.Id);

            if (result)
            {
                await ShowNotification("success", $"Xóa người dùng '{userToDelete.Name}' thành công!");
                await RefreshData();
            }
            else
            {
                await ShowNotification("error", "Không thể xóa người dùng này!");
            }
        }
        catch (Exception ex)
        {
            await ShowNotification("error", $"Lỗi khi xóa: {ex.Message}");
        }
        finally
        {
            userToDelete = null;
            isProcessing = false;
            StateHasChanged();
        }
    }

    #endregion

    #region Helper Methods

    private async Task ShowNotification(string type, string message)
    {
        try
        {
            switch (type)
            {
                case "success":
                    await NotificationService.ShowSuccessAsync(message);
                    break;
                case "error":
                    await NotificationService.ShowErrorAsync(message);
                    break;
                case "warning":
                    await NotificationService.ShowWarningAsync(message);
                    break;
                default:
                    await NotificationService.ShowInfoAsync(message);
                    break;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Notification error: {ex.Message}");
        }
    }

    #endregion
}