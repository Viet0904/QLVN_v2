@page "/system_group"
@using WebBlazor.Services
@using Common.Model.UsGroup
@using Common.Model.Common
@using Common.Library.Constant
@inject UserApiClient GroupApi
@inject NotificationService Notification
@inject IJSRuntime JS

<style>
    /* Thêm border cho MudDataGrid */
    .mud-table-bordered {
        border: 1px solid rgba(0, 0, 0, 0.12);
    }
    
    .mud-table-bordered .mud-table-head .mud-table-cell {
        border-bottom: 2px solid rgba(0, 0, 0, 0.12);
        border-right: 1px solid rgba(0, 0, 0, 0.12);
        font-weight: 600;
    }
    
    .mud-table-bordered .mud-table-cell {
        border-right: 1px solid rgba(0, 0, 0, 0.12);
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
    }
    
    .mud-table-bordered .mud-table-row:hover {
        background-color: rgba(0, 0, 0, 0.04);
    }
</style>

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Danh sách Nhóm ng??i dùng</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                          Color="Color.Primary" 
                          OnClick="@RefreshData" 
                          Title="Làm m?i" />
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudDataGrid T="UsGroupViewModel" 
                    ServerData="@(new Func<GridState<UsGroupViewModel>, Task<GridData<UsGroupViewModel>>>(LoadServerData))"
                    Filterable="false"
                    Hideable="true"
                    Dense="true"
                    Hover="true"
                    Loading="@isLoading"
                    Class="mud-table-bordered"
                    Height="calc(100vh - 300px)"
                    @ref="dataGrid">
            <ToolBarContent>
                <MudButton StartIcon="@Icons.Material.Filled.Add" 
                          Color="Color.Primary" 
                          Variant="Variant.Filled"
                          OnClick="@OpenAddModal">
                    Thêm m?i
                </MudButton>
                <MudSpacer />
                <MudTextField @bind-Value="_searchString" 
                             Placeholder="Tìm ki?m..." 
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             DebounceInterval="500"
                             OnDebounceIntervalElapsed="@OnSearch">
                </MudTextField>
            </ToolBarContent>
            <Columns>
                <PropertyColumn Property="x => x.Id" Title="Mã Nhóm" />
                <PropertyColumn Property="x => x.Name" Title="Tên Nhóm" />
                <PropertyColumn Property="x => x.Note" Title="Ghi chú" />
                <PropertyColumn Property="x => x.RowStatus" Title="Tr?ng thái">
                    <CellTemplate>
                        @if (context.Item.RowStatus == 1)
                        {
                            <MudChip Color="Color.Success" Size="Size.Small">Ho?t ??ng</MudChip>
                        }
                        else
                        {
                            <MudChip Color="Color.Error" Size="Size.Small">Không ho?t ??ng</MudChip>
                        }
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Hành ??ng" Sortable="false">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Color="Color.Info" 
                                      Size="Size.Small"
                                      OnClick="@(() => OpenEditModal(context.Item.Id))"
                                      Title="Ch?nh s?a" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                      Color="Color.Error" 
                                      Size="Size.Small"
                                      OnClick="@(() => ConfirmAndDelete(context.Item))"
                                      Title="Xóa" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="UsGroupViewModel" 
                                 PageSizeOptions="@(new int[] { 10, 25, 50, 100 })" />
            </PagerContent>
        </MudDataGrid>
    </MudCardContent>
</MudCard>

<UsGroupModal GroupModel="GroupModel"
              IsEditMode="isEditMode"
              IsProcessing="isProcessing"
              OnSubmit="HandleSaveGroup"
              OnClose="CloseModals" />

<!-- Delete Confirmation Dialog -->
<DeleteConfirmDialog @ref="deleteConfirmDialog"
                     Title="Xác nh?n xóa"
                     OnConfirm="HandleDeleteGroup" />

@code {
    // DataGrid reference
    private MudDataGrid<UsGroupViewModel>? dataGrid;
    
    // Delete dialog reference
    private DeleteConfirmDialog? deleteConfirmDialog;
    
    private UsGroupFormModel GroupModel = new();
    private bool isEditMode = false;
    private bool isProcessing = false;
    private bool isLoading = false;
    private string _searchString = string.Empty;
    
    // Store current group to delete
    private UsGroupViewModel? groupToDelete;

    // x? lý n?p ??ng các js sau khi DOM render xong
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JS.InvokeVoidAsync("adminAssetManager.initAdminLayout");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Dashboard Script Load Error: {ex.Message}");
            }
        }
    }

    // Server-side data loading
    private async Task<GridData<UsGroupViewModel>> LoadServerData(GridState<UsGroupViewModel> state)
    {
        isLoading = true;
        try
        {
            var request = new PaginatedRequest
            {
                PageNumber = state.Page + 1,
                PageSize = state.PageSize,
                SearchTerm = _searchString,
                SortColumn = state.SortDefinitions.FirstOrDefault()?.SortBy ?? string.Empty,
                SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending == true ? "desc" : "asc"
            };

            var response = await GroupApi.GetPaginatedGroupsAsync(request);

            return new GridData<UsGroupViewModel>
            {
                Items = response.Items,
                TotalItems = response.TotalRecords
            };
        }
        catch (Exception ex)
        {
            await Notification.ShowErrorAsync($"L?i t?i d? li?u: {ex.Message}");
            return new GridData<UsGroupViewModel> { Items = new List<UsGroupViewModel>(), TotalItems = 0 };
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearch()
    {
        if (dataGrid != null)
        {
            await dataGrid.ReloadServerData();
        }
    }

    private async Task RefreshData()
    {
        if (dataGrid != null)
        {
            await dataGrid.ReloadServerData();
        }
    }

    private async Task OpenAddModal()
    {
        GroupModel = new UsGroupFormModel { RowStatus = 1 };
        isEditMode = false;
        StateHasChanged();
        await JS.InvokeVoidAsync("eval", "$('#groupModal').modal('show')");
    }

    private async Task OpenEditModal(string id)
    {
        try
        {
            var group = await GroupApi.GetGroupByIdAsync(id);
            if (group != null)
            {
                GroupModel = new UsGroupFormModel
                {
                    Id = group.Id,
                    Name = group.Name,
                    Note = group.Note,
                    RowStatus = group.RowStatus
                };
                isEditMode = true;
                StateHasChanged();
                await JS.InvokeVoidAsync("eval", "$('#groupModal').modal('show')");
            }
        }
        catch (Exception ex)
        {
            await Notification.ShowErrorAsync($"L?i: {ex.Message}");
        }
    }

    private void ConfirmAndDelete(UsGroupViewModel group)
    {
        groupToDelete = group;
        deleteConfirmDialog?.Show($"B?n có ch?c ch?n mu?n xóa nhóm '{group.Name}' không?");
    }

    private async Task HandleSaveGroup()
    {
        if (isProcessing) return;
        isProcessing = true;
        
        try
        {
            if (isEditMode)
            {
                var model = new UsGroupUpdateModel 
                { 
                    Id = GroupModel.Id, 
                    Name = GroupModel.Name, 
                    Note = GroupModel.Note, 
                    RowStatus = GroupModel.RowStatus 
                };
                
                var updated = await GroupApi.UpdateGroupAsync(model);
                if (updated != null)
                {
                    await JS.InvokeVoidAsync("eval", "$('#groupModal').modal('hide')");
                    await Notification.ShowSuccessAsync(MessageConstant.UPDATED_SUCCESS);
                    await RefreshData();
                }
            }
            else
            {
                var model = new UsGroupCreateModel 
                { 
                    Name = GroupModel.Name, 
                    Note = GroupModel.Note 
                };
                
                var created = await GroupApi.CreateGroupAsync(model);
                if (created != null)
                {
                    await JS.InvokeVoidAsync("eval", "$('#groupModal').modal('hide')");
                    await Notification.ShowSuccessAsync(MessageConstant.CREATED_SUCCESS);
                    await RefreshData();
                }
            }
            await CloseModals();
        }
        catch (Exception ex)
        {
            await Notification.ShowErrorAsync(ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task HandleDeleteGroup()
    {
        if (groupToDelete == null || isProcessing) return;
        isProcessing = true;
        
        try
        {
            var result = await GroupApi.DeleteGroupAsync(groupToDelete.Id);
            if (result)
            {
                await Notification.ShowSuccessAsync($"Xóa nhóm '{groupToDelete.Name}' thành công!");
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            await Notification.ShowErrorAsync(ex.Message);
        }
        finally
        {
            groupToDelete = null;
            isProcessing = false;
        }
    }

    private async Task CloseModals()
    {
        await JS.InvokeVoidAsync("eval", "$('#groupModal').modal('hide')");
        GroupModel = new UsGroupFormModel();
        isProcessing = false;
        StateHasChanged();
    }
}
